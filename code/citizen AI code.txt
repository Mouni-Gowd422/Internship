!pip install gradio transformers torch --quiet
import gradio as gr
import torch
from transformers import AutoTokenizer, AutoModelForCausalLM, pipeline

# ğŸ”„ Load Granite model
model_name = "ibm-granite/granite-3.3-2b-instruct"
tokenizer = AutoTokenizer.from_pretrained(model_name, trust_remote_code=True)
model = AutoModelForCausalLM.from_pretrained(
    model_name,
    torch_dtype=torch.float16,
    device_map="auto",
    trust_remote_code=True
)

# âœ… Optimized pipeline (faster)
chat_pipeline = pipeline(
    "text-generation",
    model=model,
    tokenizer=tokenizer,
    max_length=512,  # ğŸ”½ Reduced for speed
    temperature=0.7,
    do_sample=True,
    pad_token_id=tokenizer.eos_token_id
)

# Sentiment model (fast + small)
sentiment_model = pipeline("sentiment-analysis")

# Global memory
chat_history = []
feedback_list = []
concerns = []

# ğŸ’¬ Smart Chat
def handle_chat(user_input):
    prompt = f"You are a helpful AI assistant for Indian public services. Answer clearly:\n\n{user_input}\n\nAnswer:"
    response = chat_pipeline(prompt)
    answer = response[0]['generated_text'].split("Answer:")[-1].strip()
    chat_history.append((user_input, answer))
    trimmed = chat_history[-5:]  # Limit to last 5 Q&A
    return "\n\n".join([f"ğŸ‘¤ {q}\nğŸ¤– {a}" for q, a in trimmed])

# ğŸ“¢ Feedback
def handle_feedback(text):
    sentiment = sentiment_model(text)[0]["label"]
    feedback_list.append((text, sentiment))
    return f"âœ… Feedback received. Sentiment: {sentiment}"

# â— Concern
def handle_concern(text):
    concerns.append(text)
    return "ğŸ“¬ Concern submitted successfully."

# ğŸ“Š Dashboard
def dashboard_summary():
    pos = sum(1 for _, s in feedback_list if s == "POSITIVE")
    neg = sum(1 for _, s in feedback_list if s == "NEGATIVE")
    dash = f"ğŸŸ¢ Positive Feedbacks: {pos}\nğŸ”´ Negative Feedbacks: {neg}\n\nğŸ“Œ Concerns:"
    dash += "\n" + "\n".join([f"â€¢ {c}" for c in concerns]) if concerns else "\nNo concerns submitted yet."
    return dash

# ğŸ› Gradio UI
with gr.Blocks(title="Citizen AI - Fast Granite Edition") as app:
    gr.HTML("<h2 style='text-align:center;'>ğŸ‡®ğŸ‡³ Citizen AI</h2><p style='text-align:center;'>Granite-powered Assistant (Fast Mode)</p>")

    with gr.Tabs():
        with gr.Tab("ğŸ’¬ Ask AI"):
            user_input = gr.Textbox(label="Ask your question")
            ask_btn = gr.Button("Ask AI")
            chat_output = gr.Textbox(label="Chat History", lines=10)
            ask_btn.click(fn=handle_chat, inputs=user_input, outputs=chat_output)

        with gr.Tab("ğŸ“¢ Feedback"):
            feedback_input = gr.Textbox(label="Write your feedback")
            feedback_btn = gr.Button("Submit Feedback")
            feedback_output = gr.Textbox(label="Status")
            feedback_btn.click(fn=handle_feedback, inputs=feedback_input, outputs=feedback_output)

        with gr.Tab("â— Raise Concern"):
            concern_input = gr.Textbox(label="Describe your concern")
            concern_btn = gr.Button("Submit Concern")
            concern_output = gr.Textbox(label="Status")
            concern_btn.click(fn=handle_concern, inputs=concern_input, outputs=concern_output)

        with gr.Tab("ğŸ“Š Dashboard"):
            dash_btn = gr.Button("Refresh Dashboard")
            dash_output = gr.Textbox(label="Summary", lines=12)
            dash_btn.click(fn=dashboard_summary, outputs=dash_output)

    gr.HTML("<p style='text-align:center;'>âš¡ Optimized for faster response | Powered by IBM Granite + Hugging Face</p>")

# ğŸš€ Launch the app
app.launch(share=True)